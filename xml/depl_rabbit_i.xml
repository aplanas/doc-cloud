<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
  %entities;
]>
<!-- Converted by suse-upgrade version 1.1 -->
<sect1 xmlns="http://docbook.org/ns/docbook"
       xmlns:xi="http://www.w3.org/2001/XInclude"
       xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0"
       xml:id="sec.depl.ostack.rabbit">

  <title>Deploying RabbitMQ</title>

  <para>
   The RabbitMQ messaging system enables services to communicate with the
   other nodes via Advanced Message Queue Protocol (AMQP). Deploying it is
   mandatory. RabbitMQ needs to be installed on a &contrnode;. RabbitMQ
   can be made highly available by deploying it on a cluster. It is
   recommended not to change the default values of the proposal's
   attributes.
  </para>

  <variablelist>
   <varlistentry>
    <term><guimenu>Virtual Host</guimenu>
    </term>
    <listitem>
     <para>
      Name of the default virtual host to be created and used by the
      RabbitMQ server (<literal>default_vhost</literal> configuration option
      in <filename>rabbitmq.config</filename>).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Port</term>
    <listitem>
     <para>
      Port the RabbitMQ server listens on (<literal>tcp_listeners</literal>
      configuration option in <filename>rabbitmq.config</filename>).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>User</term>
    <listitem>
     <para>
      RabbitMQ default user (<literal>default_user</literal> configuration
      option in <filename>rabbitmq.config</filename>).
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <figure>
   <title>The RabbitMQ &Barcl;</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="depl_barclamp_rabbitmq.png" width="100%" format="png"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="depl_barclamp_rabbitmq.png" width="75%" format="png"/>
    </imageobject>
   </mediaobject>
  </figure>

  <sect2 xml:id="sec.depl.ostack.rabbit.ha">
   <title>&haSetup; for RabbitMQ</title>
   <para>
    To make RabbitMQ highly available, deploy it on a cluster instead of
    a single &contrnode;. This also requires shared
    storage for the cluster that hosts the RabbitMQ data.
    To achieve this, either set up a cluster with
    DRBD support (see
    <xref linkend="sec.depl.ostack.pacemaker"/>) or use
    <quote>traditional</quote> shared storage like an NFS share. It is
    recommended to use a dedicated cluster to deploy RabbitMQ together with
    the database, since both components require shared storage.
   </para>
   <para>
    Deploying RabbitMQ on a cluster makes an additional <guimenu>High
    Availability</guimenu> section available in the
    <guimenu>Attributes</guimenu> section of the proposal. Configure the
    <guimenu>Storage Mode</guimenu> in this section. There are two options:
   </para>
   <variablelist>
    <varlistentry>
     <term><guimenu>DRBD</guimenu>
     </term>
     <listitem>
      <para>
       This option requires a two-node cluster that has been set up with
       DRBD. Also specify the <guimenu>Size to Allocate for DRBD Device (in
       Gigabytes)</guimenu>. The suggested value of 50 GB should be
       sufficient.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Shared Storage</term>
     <listitem>
      <para>
       Use a shared block device or an NFS mount for shared storage.
       Concordantly with the mount command, you need to specify three
       attributes: <guimenu>Name of Block Device or NFS Mount
       Specification</guimenu> (the mount point), the <guimenu>Filesystem
       Type</guimenu> and the <guimenu>Mount Options</guimenu>.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>

   <important>
    <title>NFS Export Options for Shared Storage</title>
    <para>
     An NFS share for use as a shared storage for a cluster needs
     to be exported on the NFS server with the following options:
    </para>
    <screen>rw,async,insecure,no_subtree_check,no_root_squash</screen>
    <para>
     In case mounting the NFS share on the cluster nodes fails, change the
     export options and re-apply the proposal. Before doing so, however, you
     need to clean up the respective resources on the cluster nodes as
     described in <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="&suse-onlinedoc;/sle-ha-12/book_sleha/data/sec_ha_config_crm.html#sec_ha_manual_config_cleanup"/>.
    </para>
   </important>
  </sect2>
</sect1>
